<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.school.social.mapper.PostMapper">
    <insert id="insert" parameterType="com.school.social.entity.Post" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO posts
        <trim prefix="(" suffix=")" suffixOverrides=",">
        <if test="userId != null">user_id,</if>
        <if test="title != null">title,</if>
        <if test="content != null">content,</if>
        <if test="postType != null">post_type,</if>
        <if test="status != null">status,</if>
        <if test="visibility != null">visibility,</if>
        <if test="location != null">location,</if>
        <if test="college != null">college,</if>
        <if test="likeCount != null">like_count,</if>
        <if test="commentCount != null">comment_count,</if>
        <if test="favoriteCount != null">favorite_count,</if>
        <if test="viewCount != null">view_count,</if>
        <if test="qualityScore != null">quality_score,</if>
        <if test="isPinned != null">is_pinned,</if>
        <if test="isFeatured != null">is_featured,</if>
        <if test="createdAt != null">created_at,</if>
        <if test="updatedAt != null">updated_at,</if>
        <if test="publishedAt != null">published_at,</if>
        </trim>
        <trim prefix="VALUES (" suffix=")" suffixOverrides=",">
        <if test="userId != null">#{userId},</if>
        <if test="title != null">#{title},</if>
        <if test="content != null">#{content},</if>
        <if test="postType != null">#{postType},</if>
        <if test="status != null">#{status},</if>
        <if test="visibility != null">#{visibility},</if>
        <if test="location != null">#{location},</if>
        <if test="college != null">#{college},</if>
        <if test="likeCount != null">#{likeCount},</if>
        <if test="commentCount != null">#{commentCount},</if>
        <if test="favoriteCount != null">#{favoriteCount},</if>
        <if test="viewCount != null">#{viewCount},</if>
        <if test="qualityScore != null">#{qualityScore},</if>
        <if test="isPinned != null">#{isPinned},</if>
        <if test="isFeatured != null">#{isFeatured},</if>
        <if test="createdAt != null">#{createdAt},</if>
        <if test="updatedAt != null">#{updatedAt},</if>
        <if test="publishedAt != null">#{publishedAt},</if>
        </trim>
    </insert>
    <update id="updateById" parameterType="com.school.social.entity.Post">
        UPDATE posts
        <set>
        <if test="userId != null">user_id = #{userId},</if>
        <if test="title != null">title = #{title},</if>
        <if test="content != null">content = #{content},</if>
        <if test="postType != null">post_type = #{postType},</if>
        <if test="status != null">status = #{status},</if>
        <if test="visibility != null">visibility = #{visibility},</if>
        <if test="location != null">location = #{location},</if>
        <if test="college != null">college = #{college},</if>
        <if test="likeCount != null">like_count = #{likeCount},</if>
        <if test="commentCount != null">comment_count = #{commentCount},</if>
        <if test="favoriteCount != null">favorite_count = #{favoriteCount},</if>
        <if test="viewCount != null">view_count = #{viewCount},</if>
        <if test="qualityScore != null">quality_score = #{qualityScore},</if>
        <if test="isPinned != null">is_pinned = #{isPinned},</if>
        <if test="isFeatured != null">is_featured = #{isFeatured},</if>
        <if test="createdAt != null">created_at = #{createdAt},</if>
        <if test="updatedAt != null">updated_at = #{updatedAt},</if>
        <if test="publishedAt != null">published_at = #{publishedAt},</if>
        </set>
        WHERE id = #{id}
    </update>
    <delete id="deleteById" parameterType="long">
        DELETE FROM posts WHERE id = #{id}
    </delete>
    <select id="selectById" parameterType="long" resultType="com.school.social.entity.Post">
        SELECT id, user_id, title, content, post_type, status, visibility, location, college, like_count, comment_count, favorite_count, view_count, quality_score, is_pinned, is_featured, created_at, updated_at, published_at FROM posts WHERE id = #{id}
    </select>
    <select id="selectAll" resultType="com.school.social.entity.Post">
        SELECT id, user_id, title, content, post_type, status, visibility, location, college, like_count, comment_count, favorite_count, view_count, quality_score, is_pinned, is_featured, created_at, updated_at, published_at FROM posts
    </select>
    <select id="selectByUserId" resultType="com.school.social.entity.Post">
        SELECT id, user_id, title, content, post_type, status, visibility, location, college, like_count, comment_count, favorite_count, view_count, quality_score, is_pinned, is_featured, created_at, updated_at, published_at
        FROM posts
        WHERE user_id = #{userId}
        ORDER BY created_at DESC
    </select>
    <select id="selectByUserIdPaged" resultType="com.school.social.entity.Post">
        SELECT id, user_id, title, content, post_type, status, visibility, location, college, like_count, comment_count, favorite_count, view_count, quality_score, is_pinned, is_featured, created_at, updated_at, published_at
        FROM posts
        WHERE user_id = #{userId}
        ORDER BY created_at DESC
        LIMIT #{size} OFFSET #{offset}
    </select>
    <select id="countByUserId" resultType="int">
        SELECT COUNT(1) FROM posts WHERE user_id = #{userId}
    </select>
    <select id="selectPaged" resultType="com.school.social.entity.Post">
        SELECT id, user_id, title, content, post_type, status, visibility, location, college, like_count, comment_count, favorite_count, view_count, quality_score, is_pinned, is_featured, created_at, updated_at, published_at
        FROM posts
        <where>
            <if test="status != null">
                status = #{status}
            </if>
        </where>
        ORDER BY created_at DESC
        LIMIT #{size} OFFSET #{offset}
    </select>
    <select id="countByStatus" resultType="int">
        SELECT COUNT(1)
        FROM posts
        <where>
            <if test="status != null">
                status = #{status}
            </if>
        </where>
    </select>

    <select id="selectRecommendPaged" resultType="com.school.social.entity.Post">
        SELECT id, user_id, title, content, post_type, status, visibility, location, college,
               like_count, comment_count, favorite_count, view_count, quality_score,
               is_pinned, is_featured, created_at, updated_at, published_at
        FROM posts
        WHERE status IN (0, 1)
        ORDER BY IFNULL(is_pinned, 0) DESC,
                 IFNULL(is_featured, 0) DESC,
                 IFNULL(quality_score, 0) DESC,
                 created_at DESC
        LIMIT #{size} OFFSET #{offset}
    </select>
    <select id="countRecommend" resultType="int">
        SELECT COUNT(1) FROM posts WHERE status IN (0, 1)
    </select>

    <select id="selectLatestPaged" resultType="com.school.social.entity.Post">
        SELECT id, user_id, title, content, post_type, status, visibility, location, college,
               like_count, comment_count, favorite_count, view_count, quality_score,
               is_pinned, is_featured, created_at, updated_at, published_at
        FROM posts
        WHERE status IN (0, 1)
        ORDER BY created_at DESC
        LIMIT #{size} OFFSET #{offset}
    </select>
    <select id="countLatest" resultType="int">
        SELECT COUNT(1) FROM posts WHERE status IN (0, 1)
    </select>

    <select id="selectHotPaged" resultType="com.school.social.entity.Post">
        SELECT id, user_id, title, content, post_type, status, visibility, location, college,
               like_count, comment_count, favorite_count, view_count, quality_score,
               is_pinned, is_featured, created_at, updated_at, published_at
        FROM posts
        WHERE status IN (0, 1)
        ORDER BY (IFNULL(like_count, 0) + IFNULL(comment_count, 0) +
                  IFNULL(favorite_count, 0) + IFNULL(view_count, 0)) DESC,
                 created_at DESC
        LIMIT #{size} OFFSET #{offset}
    </select>
    <select id="countHot" resultType="int">
        SELECT COUNT(1) FROM posts WHERE status IN (0, 1)
    </select>

    <select id="selectByTagPaged" resultType="com.school.social.entity.Post">
        SELECT p.id, p.user_id, p.title, p.content, p.post_type, p.status, p.visibility,
               p.location, p.college, p.like_count, p.comment_count, p.favorite_count,
               p.view_count, p.quality_score, p.is_pinned, p.is_featured,
               p.created_at, p.updated_at, p.published_at
        FROM posts p
        INNER JOIN post_tags pt ON p.id = pt.post_id
        WHERE pt.tag_id = #{tagId}
          AND p.status IN (0, 1)
        ORDER BY p.created_at DESC
        LIMIT #{size} OFFSET #{offset}
    </select>
    <select id="countByTag" resultType="int">
        SELECT COUNT(1)
        FROM posts p
        INNER JOIN post_tags pt ON p.id = pt.post_id
        WHERE pt.tag_id = #{tagId}
          AND p.status IN (0, 1)
    </select>

    <select id="selectByFolloweePaged" resultType="com.school.social.entity.Post">
        SELECT p.id, p.user_id, p.title, p.content, p.post_type, p.status, p.visibility,
               p.location, p.college, p.like_count, p.comment_count, p.favorite_count,
               p.view_count, p.quality_score, p.is_pinned, p.is_featured,
               p.created_at, p.updated_at, p.published_at
        FROM posts p
        INNER JOIN follows f ON f.followee_id = p.user_id
        WHERE f.follower_id = #{userId}
          AND p.status IN (0, 1)
        ORDER BY p.created_at DESC
        LIMIT #{size} OFFSET #{offset}
    </select>
    <select id="countByFollowee" resultType="int">
        SELECT COUNT(1)
        FROM posts p
        INNER JOIN follows f ON f.followee_id = p.user_id
        WHERE f.follower_id = #{userId}
          AND p.status IN (0, 1)
    </select>

    <select id="searchPaged" resultType="com.school.social.entity.Post">
        SELECT DISTINCT p.id, p.user_id, p.title, p.content, p.post_type, p.status, p.visibility,
               p.location, p.college, p.like_count, p.comment_count, p.favorite_count,
               p.view_count, p.quality_score, p.is_pinned, p.is_featured,
               p.created_at, p.updated_at, p.published_at
        FROM posts p
        <if test="tagId != null">
            INNER JOIN post_tags pt ON p.id = pt.post_id
        </if>
        <where>
            p.status IN (0, 1)
            <if test="keyword != null and keyword != ''">
                AND (p.title LIKE CONCAT('%', #{keyword}, '%')
                OR p.content LIKE CONCAT('%', #{keyword}, '%'))
            </if>
            <if test="tagId != null">
                AND pt.tag_id = #{tagId}
            </if>
        </where>
        ORDER BY p.created_at DESC
        LIMIT #{size} OFFSET #{offset}
    </select>
    <select id="countSearch" resultType="int">
        SELECT COUNT(DISTINCT p.id)
        FROM posts p
        <if test="tagId != null">
            INNER JOIN post_tags pt ON p.id = pt.post_id
        </if>
        <where>
            p.status IN (0, 1)
            <if test="keyword != null and keyword != ''">
                AND (p.title LIKE CONCAT('%', #{keyword}, '%')
                OR p.content LIKE CONCAT('%', #{keyword}, '%'))
            </if>
            <if test="tagId != null">
                AND pt.tag_id = #{tagId}
            </if>
        </where>
    </select>

    <select id="selectRelatedByTagIds" resultType="com.school.social.entity.Post">
        SELECT p.id, p.user_id, p.title, p.content, p.post_type, p.status, p.visibility,
               p.location, p.college, p.like_count, p.comment_count, p.favorite_count,
               p.view_count, p.quality_score, p.is_pinned, p.is_featured,
               p.created_at, p.updated_at, p.published_at
        FROM posts p
        INNER JOIN post_tags pt ON p.id = pt.post_id
        WHERE pt.tag_id IN
        <foreach collection="tagIds" item="tagId" open="(" separator="," close=")">
            #{tagId}
        </foreach>
          AND p.id != #{excludeId}
          AND p.status IN (0, 1)
        GROUP BY p.id
        ORDER BY COUNT(1) DESC, p.created_at DESC
        LIMIT #{limit}
    </select>

    <update id="increaseLikeCount">
        UPDATE posts
        SET like_count = IFNULL(like_count, 0) + 1
        WHERE id = #{postId}
    </update>
    <update id="decreaseLikeCount">
        UPDATE posts
        SET like_count = GREATEST(IFNULL(like_count, 0) - 1, 0)
        WHERE id = #{postId}
    </update>
    <update id="increaseFavoriteCount">
        UPDATE posts
        SET favorite_count = IFNULL(favorite_count, 0) + 1
        WHERE id = #{postId}
    </update>
    <update id="decreaseFavoriteCount">
        UPDATE posts
        SET favorite_count = GREATEST(IFNULL(favorite_count, 0) - 1, 0)
        WHERE id = #{postId}
    </update>
    <update id="increaseCommentCount">
        UPDATE posts
        SET comment_count = IFNULL(comment_count, 0) + 1
        WHERE id = #{postId}
    </update>
    <update id="decreaseCommentCount">
        UPDATE posts
        SET comment_count = GREATEST(IFNULL(comment_count, 0) - 1, 0)
        WHERE id = #{postId}
    </update>
    <update id="decreaseCommentCountBy">
        UPDATE posts
        SET comment_count = GREATEST(IFNULL(comment_count, 0) - #{amount}, 0)
        WHERE id = #{postId}
    </update>

</mapper>
